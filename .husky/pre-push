#!/usr/bin/env sh

# Pre-push hook: Run the same checks as CI
# This ensures local validation matches CI pipeline exactly

echo "ğŸ” Running pre-push checks (same as CI)..."

echo ""
echo "ğŸ“‹ Step 1/6: Biome check (lint + format)..."
pnpm run check || exit 1

echo ""
echo "ğŸ“‹ Step 2/6: TypeScript type check..."
pnpm run type-check || exit 1

echo ""
echo "ğŸ“‹ Step 3/6: Running TypeScript tests..."
pnpm --recursive run test || exit 1

echo ""
echo "ğŸ“‹ Step 4/6: Running PHP tests..."
# Ensure PHP dependencies are installed
if [ ! -d "apps/sabredav/vendor" ]; then
    echo "âš ï¸  PHP dependencies not installed. Installing..."
    (cd apps/sabredav && composer install --no-interaction --prefer-dist --quiet) || exit 1
fi
pnpm run test:php || exit 1

echo ""
echo "ğŸ“‹ Step 5/6: Build verification..."
pnpm run build || exit 1

echo ""
echo "ğŸ“‹ Step 6/6: Running E2E tests..."
pnpm --filter frontend exec playwright test --project=chromium || exit 1

echo ""
echo "âœ… All pre-push checks passed!"
